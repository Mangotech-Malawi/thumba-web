<!-- Alpine Tabs -->
<div x-data="dashboardTabs()" x-init="initTabs()">
  <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
    <template x-if="canSee('loans')">
      <li class="nav-item">
        <a id="loan-dashboard" class="nav-link" :class="{active: activeTab === 'loans-dashboard'}"
          @click="setTab('loans-dashboard')" data-toggle="tab" href="#loans-dashboard" role="tab">
          Loans Dashboard
        </a>
      </li>
    </template>
    <template x-if="canSee('finance')">
      <li class="nav-item">
        <a id="finance-dashboard" class="nav-link" :class="{active: activeTab === 'finance-performance'}"
          @click="setTab('finance-performance')" data-toggle="tab" href="#finance-performance" role="tab">
          Finance Performance
        </a>
      </li>
    </template>
    <template x-if="canSee('shares')">
      <li class="nav-item">
        <a id="shares-dashboard" class="nav-link" :class="{active: activeTab === 'shares-performance'}"
          @click="setTab('shares-performance')" data-toggle="tab" href="#shares-performance" role="tab">
          Shares Performance
        </a>
      </li>
    </template>
    <template x-if="canSee('admin')">
      <li class="nav-item">
        <a id="system-adminstration-dashboard" class="nav-link" :class="{active: activeTab === 'system-admin'}"
          @click="setTab('system-admin')" data-toggle="tab" href="#system-admin" role="tab">
          System Administration
        </a>
      </li>
    </template>
    <template x-if="canSee('system-reports')">
      <li class="nav-item">
        <a id="system-reports-tab" class="nav-link" :class="{active: activeTab === 'system-reports'}"
          @click="setTab('system-reports')" data-toggle="tab" href="#system-reports" role="tab">
          System Reports
        </a>
      </li>
    </template>
  </ul>

  <!-- Tab Contents -->
  <div class="tab-content" id="dashboardTabsContent">
    <div class="tab-pane fade" :class="{ 'show active': activeTab === 'loans-dashboard' }" id="loans-dashboard" role="tabpanel" x-show="canSee('loans')"></div>
    <div class="tab-pane fade" :class="{ 'show active': activeTab === 'finance-performance' }" id="finance-performance" role="tabpanel" x-show="canSee('finance')"></div>
    <div class="tab-pane fade" :class="{ 'show active': activeTab === 'shares-performance' }" id="shares-performance" role="tabpanel" x-show="canSee('branches')"></div>
    <div class="tab-pane fade" :class="{ 'show active': activeTab === 'system-admin' }" id="system-admin" role="tabpanel" x-show="canSee('admin')"></div>
    <div class="tab-pane fade" :class="{ 'show active': activeTab === 'system-reports' }" id="system-reports" role="tabpanel" x-show="canSee('system-reports')"></div>
  </div>
</div>
<script>
  function dashboardTabs() {
    const privileges = JSON.parse(sessionStorage.getItem("privileges")) || [];
    const isOwner = privileges.some(p => p.name === "owner_reports");

    return {
      activeTab: 'loans-dashboard',

      canSee(tab) {
        if (isOwner) return tab !== 'system-reports';
        if (tab === 'loans') return privileges.some(p => p.name === 'loan_officer_reports' || p.name === 'owner_reports');
        if (tab === 'finance') return privileges.some(p => p.name === 'owner_reports');
        if (tab === 'branches') return privileges.some(p => p.name === 'branch_reports');
        if (tab === 'admin') return privileges.some(p => p.name === 'admin_reports');
        if (tab === 'system-reports') return privileges.some(p => p.name === 'system_reports');
        return false;
      },

      setTab(tabId) {
        this.activeTab = tabId;
        localStorage.setItem("dashboard_first_tab", tabId);
      },

      initTabs() {
        this.$nextTick(() => {
          // Get first visible tab link and trigger click
          const firstVisibleTab = document.querySelector("#dashboardTabs .nav-link:not([style*='display: none'])");
          if (firstVisibleTab) {
            firstVisibleTab.click();
            localStorage.setItem("dashboard_first_tab", firstVisibleTab.id);
          }
        });
      }
    };
  }
</script>