<!-- Alpine Reports Tabs -->
<div x-data="reportsTabs()" x-init="initTabs()">
  <ul class="nav nav-tabs" id="reportsTabs" role="tablist">
    <template x-if="canSee('loans')">
      <li class="nav-item">
        <a id="loan-reports" class="nav-link" :class="{active: activeTab === 'loans-reports'}"
          @click="setTab('loans-reports')" data-toggle="tab" href="#loans-reports" role="tab">
          Loans Reports
        </a>
      </li>
    </template>

    <template x-if="canSee('finance')">
      <li class="nav-item">
        <a id="finance-reports" class="nav-link" :class="{active: activeTab === 'finance-reports'}"
          @click="setTab('finance-reports')" data-toggle="tab" href="#finance-reports" role="tab">
          Finance Reports
        </a>
      </li>
    </template>

    <template x-if="canSee('shares')">
      <li class="nav-item">
        <a id="shares-reports" class="nav-link" :class="{active: activeTab === 'shares-reports'}"
          @click="setTab('shares-reports')" data-toggle="tab" href="#shares-reports" role="tab">
          Shareholder Reports
        </a>
      </li>
    </template>

    <template x-if="canSee('admin')">
      <li class="nav-item">
        <a id="system-admin-reports" class="nav-link" :class="{active: activeTab === 'system-admin-reports'}"
          @click="setTab('system-admin-reports')" data-toggle="tab" href="#system-admin-reports" role="tab">
          System Administration Reports
        </a>
      </li>
    </template>

    <template x-if="canSee('system-reports')">
      <li class="nav-item">
        <a id="system-reports-main" class="nav-link" :class="{active: activeTab === 'system-reports-main'}"
          @click="setTab('system-reports-main')" data-toggle="tab" href="#system-reports-main" role="tab">
          System Reports
        </a>
      </li>
    </template>
  </ul>

  <!-- Reports Tab Contents -->
  <div class="tab-content" id="reportsTabsContent">
    <div class="tab-pane fade" :class="{ 'show active': activeTab === 'loans-reports' }" id="loans-reports" role="tabpanel" x-show="canSee('loans')"></div>
    <div class="tab-pane fade" :class="{ 'show active': activeTab === 'finance-reports' }" id="finance-reports" role="tabpanel" x-show="canSee('finance')"></div>
    <div class="tab-pane fade" :class="{ 'show active': activeTab === 'shares-reports' }" id="shares-reports" role="tabpanel" x-show="canSee('shares')"></div>
    <div class="tab-pane fade" :class="{ 'show active': activeTab === 'system-admin-reports' }" id="system-admin-reports" role="tabpanel" x-show="canSee('admin')"></div>
    <div class="tab-pane fade" :class="{ 'show active': activeTab === 'system-reports-main' }" id="system-reports-main" role="tabpanel" x-show="canSee('system-reports')"></div>
  </div>
</div>

<script>
  function reportsTabs() {
    const privileges = JSON.parse(sessionStorage.getItem("privileges")) || [];
    const isOwner = privileges.some(p => p.name === "owner_reports");

    return {
      activeTab: 'loans-reports',

      canSee(tab) {
        if (isOwner) return tab !== 'system-reports';
        if (tab === 'loans') return privileges.some(p => p.name === 'loan_officer_reports' || p.name === 'owner_reports');
        if (tab === 'finance') return privileges.some(p => p.name === 'owner_reports');
        if (tab === 'shares') return privileges.some(p => p.name === 'branch_reports');
        if (tab === 'admin') return privileges.some(p => p.name === 'admin_reports');
        if (tab === 'system-reports') return privileges.some(p => p.name === 'system_reports');
        return false;
      },

      setTab(tabId) {
        this.activeTab = tabId;
        localStorage.setItem("reports_first_tab", tabId);
      },

      initTabs() {
        this.$nextTick(() => {
          const firstVisibleTab = document.querySelector("#reportsTabs .nav-link:not([style*='display: none'])");
          if (firstVisibleTab) {
            firstVisibleTab.click();
            localStorage.setItem("reports_first_tab", firstVisibleTab.id);
          }
        });
      }
    };
  }
</script>