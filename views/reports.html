<!-- Alpine Reports Tabs -->
<div x-data="reportsTabs()" x-init="initTabs()">
  <ul class="nav nav-tabs" id="reportsTabs" role="tablist">
    <template x-if="canSee('loans')">
      <li class="nav-item">
        <a id="loan-reports-tab" class="nav-link" :class="{active: activeTab === 'loan-reports'}"
           @click="setTab('loan-reports')" data-toggle="tab" href="#loan-reports" role="tab">
          Loan Report
        </a>
      </li>
    </template>

    <template x-if="canSee('finance')">
      <li class="nav-item">
        <a id="finance-reports-tab" class="nav-link" :class="{active: activeTab === 'finance-reports'}"
           @click="setTab('finance-reports')" data-toggle="tab" href="#finance-reports" role="tab">
          Finance Report
        </a>
      </li>
    </template>

    <template x-if="canSee('shares')">
      <li class="nav-item">
        <a id="shares-reports-tab" class="nav-link" :class="{active: activeTab === 'shares-reports'}"
           @click="setTab('shares-reports')" data-toggle="tab" href="#shares-reports" role="tab">
          Shareholder Report
        </a>
      </li>
    </template>

    <template x-if="canSee('admin')">
      <li class="nav-item">
        <a id="admin-reports-tab" class="nav-link" :class="{active: activeTab === 'admin-reports'}"
           @click="setTab('admin-reports')" data-toggle="tab" href="#admin-reports" role="tab">
          System Administration Report
        </a>
      </li>
    </template>

    <template x-if="canSee('system')">
      <li class="nav-item">
        <a id="system-reports-tab" class="nav-link" :class="{active: activeTab === 'system-reports'}"
           @click="setTab('system-reports')" data-toggle="tab" href="#system-reports" role="tab">
          System Reports
        </a>
      </li>
    </template>
  </ul>

  <!-- Tab Contents -->
  <div class="tab-content" id="reportsTabsContent">
    <div class="tab-pane fade" :class="{ 'show active': activeTab === 'loan-reports' }" id="loan-reports" role="tabpanel" x-show="canSee('loans')"></div>
    <div class="tab-pane fade" :class="{ 'show active': activeTab === 'finance-reports' }" id="finance-reports" role="tabpanel" x-show="canSee('finance')"></div>
    <div class="tab-pane fade" :class="{ 'show active': activeTab === 'shares-reports' }" id="shares-reports" role="tabpanel" x-show="canSee('shares')"></div>
    <div class="tab-pane fade" :class="{ 'show active': activeTab === 'admin-reports' }" id="admin-reports" role="tabpanel" x-show="canSee('admin')"></div>
    <div class="tab-pane fade" :class="{ 'show active': activeTab === 'system-reports' }" id="system-reports" role="tabpanel" x-show="canSee('system')"></div>
  </div>
</div>

<script>
  function reportsTabs() {
    const privileges = JSON.parse(sessionStorage.getItem("privileges")) || [];
    const isOwner = privileges.some(p => p.name === "owner_reports");

    return {
      activeTab: localStorage.getItem("reports_active_tab") || "loan-reports",

      canSee(tab) {
        if (isOwner) return tab !== 'system';
        const map = {
          loans: ['loan_officer_reports', 'owner_reports'],
          finance: ['owner_reports', 'finance_reports'],
          shares: ['branch_reports', 'owner_reports'],
          admin: ['admin_reports'],
          system: ['system_reports']
        };
        return privileges.some(p => map[tab]?.includes(p.name));
      },

      setTab(tabId) {
        this.activeTab = tabId;
        localStorage.setItem("reports_active_tab", tabId);
      },

      initTabs() {
        this.$nextTick(() => {
          const firstVisibleTab = document.querySelector("#reportsTabs .nav-link:not([style*='display: none'])");
          if (firstVisibleTab) {
            firstVisibleTab.click();
            localStorage.setItem("reports_first_tab", firstVisibleTab.id);
          }
        });
      }
    };
  }
</script>