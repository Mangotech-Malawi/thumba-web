name: Sync Web -> Cordova App ( Incremental)

on: 
  push: 
    branches:
      - main

jobs: 
  sync:
  # Only run for merged PRs or direct pushes 
    if: github.event_name == 'push' || ( github.event_name == 'pull_request' && github.event.pull_request.merged == true ) 
    runs-on: ubuntu-latest

    steps: 
      - name: Checkout thumba-Web
        uses: actions/checkout@v4 

      - name: Clone thumba-cordova repo
        uses: actions/checkout@v4
        with: 
          repository: Mangotech-Malawi/thumba-cordova
          token: ${{ secrets.THUMBA_SYNC_TOKEN }}
          path: thumba-cordova

      - name: Copy only changed files
        run: | 
          # Sync everything from thumba-web into thumba-cordova/www
          # Only updates changed files, deletes files removed in thumba-web
          rsync -av --delete --exclude='.git' ./ thumba-cordova/www

      - name: Commit & push updates to thumba-cordova
        run: | 
          cd thumba-cordova
          git config user.email "actions@github.com"
          git config user.name "Github Actions"
          git add . 
          git commit -m "Auto-sync from thumba-web main" || echo "No changes"
          git push 
        env:
          GITHUB_TOKEN: ${{ secrets.THUMBA_SYNC_TOKEN }}